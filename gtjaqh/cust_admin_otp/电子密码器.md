客户管理员和客户通过认证接口来进行登录

状态：
enabled:启用禁用状态，0是已被禁用，1表示正常启用
locked:锁定状态，0，正常；1，临时锁定，2永久锁定
unlocktime：锁定时间 UTC时间，秒
lost：挂失状态，0:未挂失正常使用 1:挂失
invalid: 作废状态，0表示正常，1表示已作废，作废后不可逆转
actived：令牌激活密钥更新，-1表示不支持令牌激活
expired:0是未过期，1表示已过期
expiretime:令牌过期时间，UTC时间，秒



本地状态：

启用  1

禁用  0

锁定 -1

挂失 -2 

作废 -3 

过期 -4



**电子密码器查询：**

先查询出所有的启用状态的未过期的令牌，再查询出所有的别的公司的令牌（t_company_token），去掉启用令牌中的已分配到别的公司的令牌。

如果存在userid，则过滤已启用的令牌中当前用户已分配的令牌

**电子密码器增发：**

先插入到t_company_token，再查询管理员下的客户，调用iuc批量绑定接口，最后添加操作到记录表中（t_otp_record）

**iuc批量绑定接口：**

添加userid, name, domainid, createtime 这条记录到ftotp_userinfo中，如果已存在姓名是否一致，不一致则更新姓名，如果不存在则插入新的记录

再插入记录到ftotp_usertoken中，同样已存在的不动，只添加新增的记录

**电子密码器解绑：**

循环遍历userid, 直接删除ftotp_usertoken的记录

**新增客户管理员**：

校验：

手机号和邮箱可以为空，手机号或邮箱不为空则作校验

查询t_company_user中是否已经入参中的手机号或邮箱（管理员级别），再调用iuc接口查询手机号或邮箱是否绑定到别的客户或管理员上。

唯一管理员校验，公司已存在别的管理员则不能再注册

如果公司名为空，根据入参中的统信号获取公司名

如果公司投资者类型为空，则获取投资者类型

调用iuc创建客户管理员接口，传入手机号 邮箱 姓名 操作员 返回userid 。认证中心（通过公司首字母前6位+@vip.gtjaqh.com）虚拟邮箱注册

插入管理员信息到t_company_user, t_company, t_company_department

挂接统信user_identity

添加管理员资产账号 是否开启继承功能 添加数据权限记录

添加业务权限 添加业务权限记录

添加协议文件

添加密码器

添加完所有逻辑后，生成登录密码（暂时不发送）

**编辑客户管理员：**

校验手机号和邮箱格式，是否被注册过（与新增客户管理员相同）

用户状态检验（活跃用户）

调用iuc更新接口，支持同时修改手机号和邮箱

更新t_company_user表，user_identity

添加管理员资产账号 是否开启继承功能 添加数据权限记录

添加业务权限 添加业务权限记录

修改协议文件

增发电子密码器

锁定或解锁用户 （锁定时登录态降权）

**注销公司：**

查找公司下的所有管理员，调用iuc删除接口

删除管理员创建的公司部门，资产数据权限，业务权限

查询出该管理员下的客户 注销客户  删除绑定的部门  解除用户与公司的关联身份 查询出与用户绑定的资产账号，并解绑 查询出与用户绑定的角色,并解绑   解绑角色  是否还有挂接的公司，回收服务密码

禁用管理员绑定的所有令牌

**电子密码器权限分配**：

查询日志表中管理员所拥有的电子密码器最新的记录

 检验本地状态与otp状态是否一致，不一致则操作员和更新时间都为空

**电子密码器操作日志**：

插入时多添加操作的管理员id，查询时查询本管理员的操作记录

绑定时添加绑定的管理员id，解绑时添加解绑的管理员id

状态变更时查询所有的关联到此密码器的管理员id，并对应地插入多条记录，这样查询时，和此电子密码器关联的管理员操作日志中都可以看到电子密码器状态的变更



8.1更新

getTokenSNs

查询otp中ftotp_tokeninfo中启用未过期的令牌，再查询ftotp_user_token表已分配的令牌，去除已分配的令牌，管理员已分配的令牌查询操作员模式分配的令牌和unicorn中已分配的令牌取并集，同样去除已分配的这些令牌，之后在未分配的令牌列表中硬件令牌在前，手机令牌在后

